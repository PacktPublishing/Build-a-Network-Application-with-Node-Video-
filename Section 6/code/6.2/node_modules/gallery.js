
// paginated_gallery.js
//
// Packt Publishing - Build a Network Application with Node
// Display images uploaded by the user, with pagination

var errUtil = require("err_util"),
  fs = require("fs");

module.exports = function(req, res, next) {

  var html = "",
    position = {},
    imgFiles = [],
    count = 0,
    pageSize = 5,
    pageIndex = req.query.page;

  // List uploaded images and their filenames
  fs.readdir("./public/img", function(err, files) {

    if (err) return next(errUtil.report(err, res));

    pageIndex = (!pageIndex || isNaN(pageIndex)) ? 1 : parseInt(pageIndex);
    position = { start: (pageIndex-1) * pageSize , end: pageIndex * pageSize };

    if (files.length) {
      files.forEach(function(file) {
        if (/\.(jpeg|jpg|gif|png)$/.test(file)) imgFiles.push(file);
      });
      if (imgFiles.length && position.start > (imgFiles.length-1)) {
        return next(errUtil.report(null, res, 404, "Page index out of range."));
      }
    }

    res.writeHead(200, { "Content-Type": "text/html" });
    if (imgFiles.length) {

      html = '<h1>Image gallery</h1><p style="position:relative; width:640px; height:20px">';
      if (pageIndex != 1) {
        html += '<a href="/gallery/?page=' + (pageIndex-1) + '">&laquo; Previous</a>';
      }
      if (position.end < imgFiles.length) {
        html += '<a style="position:absolute; right:0" href="/gallery/?page=' + (pageIndex+1) + '">Next &raquo;</a>';
      }
      html += "</p>";

      imgFiles.forEach(function(file) {
        if (count++ >= position.start && pageSize-- > 0) {
          html += '<br/><img src="/img/' + file + '" width="640" height="480" /><br/>' + file + '<br/>';
        }
      });
    }
    res.end(html || "<p>Sorry, no images in the gallery.</p>");

  });
};