  
// static.js
//
// Packt Publishing - Build a Network Application with Node
// Serve static image files

var errUtil = require("err_util"),
  path = require("path"),
  fs = require("fs"),
  mime = require("mime");

module.exports = function(req, res) {

  var filePath = path.normalize("." + req.url),
    contentType = mime.lookup(filePath);

  fs.stat(filePath, function(err, stats) {

    if (typeof stats == "undefined") return errUtil.report(null, res, 404, "File not found: " + filePath);
    if (err) return errUtil.report(err, res);
    if (stats.isDirectory() || !/image\/(jpeg|gif|png)/.test(contentType)) return errUtil.report(null, res, 403, "Forbidden");

    fs.readFile(filePath, function(err, data) {
      if (err) return errUtil.report(err, res);

      res.writeHead(200, { "Content-Type": contentType });
      res.end(data);
    });

  });
};