
// upload.js
//
// Packt Publishing - Build a Network Application with Node
// Process images uploaded by the user

var path = require("path"),
  fs = require("fs"),
  formidable = require("formidable");

module.exports = function(req, res) {

  var i = 0,
    files = [],
    form = new formidable.IncomingForm(),

    deleteTempFile = function(filePath, cb) {
      fs.unlink(filePath, function (err) {
        if (err) return console.log(err);
        if (typeof cb == "function") cb();
      });
    },

    handleUploads = function() {

      // Redirect to gallery
      if (!files.length || i == files.length) {
        res.writeHead(302, { "Location": "/gallery" });
        res.end();
        return;
      }

      var currFile = files[i++],
        isImageType = /image\/(jpeg|gif|png)/.test(currFile.type),
        destFile = path.dirname(currFile.path) + "/" + currFile.name;

      // Uploaded file is not an image, so delete it
      if (!isImageType) return deleteTempFile(currFile.path, handleUploads);

      fs.exists(destFile, function(exists) {
        // Uploaded file already exists, so delete the duplicate
        if (exists) return deleteTempFile(currFile.path, handleUploads);

        // Rename the file to match the filename that the user uploaded
        fs.rename(currFile.path, destFile, function (err) {
          if (err) return console.log(err);
          handleUploads();
        });
      });
    };

  form.uploadDir = process.cwd() + "/img";
  form.on('file', function(field, file) { files.push(file); })
  form.on('end', handleUploads);
  form.parse(req);

};